# 1) Резюме и цель

Сделать локальный инструмент, куда я подаю **URL (Uniform Resource Locator — унифицированный указатель ресурса)** YouTube-видео, а на выходе получаю:

1. аудиофайл (по умолчанию `.m4a`, **AAC — Advanced Audio Coding**),
2. обновлённый **RSS-фид (Really Simple Syndication — формат ленты)** с записью, чтобы подписаться из телефона и слушать офлайн/онлайн.

**Почему:** упростить потребление длинных видео «в уши» без лишних шагов; весь процесс под моим контролем, приватно.

**Охват первой версии (MVP — Minimum Viable Product, минимально жизнеспособный продукт):** CLI-утилита (Command-Line Interface — интерфейс командной строки), один конфиг, один **RSS**.

---

# 2) Пользователь и сценарии

**Персона:** я сам, технический пользователь macOS, умею ставить `ffmpeg` и `yt-dlp`.

**Главные сценарии:**

* S1: «Быстро забрать лекцию в подкаст». Вставляю ссылку → через пару минут эпизод появляется в моём подкаст-клиенте.
* S2: «Пакетная обработка». Кидаю несколько ссылок за раз.
* S3: «Без дублей». Если одна и та же ссылка обработана ранее, второй раз в фид не попадает.
* S4: «Слушать с телефона». Подписываюсь на **RSS**-URL, вижу новые эпизоды.
* S5 (опционально): «Пере-хостинг». Раздаю **RSS** и медиа через статический хостинг (GitHub Pages, S3/R2, свой **HTTP — HyperText Transfer Protocol — протокол передачи гипертекста**-сервер).

---

# 3) Объём работ: что входит / не входит

**Входит (v1):**

* Загрузка аудио дорожки из YouTube через `yt-dlp`.
* Конверт в **AAC** (`.m4a`) или **MP3 (MPEG-1 Audio Layer III)** через `ffmpeg`.
* Создание/обновление `rss.xml` в формате **RSS 2.0** + базовые поля **iTunes**.
* **GUID** эпизода = YouTube Video ID, чтобы исключать дубли.
* Простая конфигурация: `SITE_URL`, `MEDIA_BASE_URL`, формат аудио, лимит элементов.

**Не входит (v1):**

* Веб-интерфейс, очереди, база данных.
* Авторизация, многопользовательский режим.
* Обход региональных/возрастных ограничений, приватных видео.
* Авто-заливка в облако (можно сделать как «последующий шаг»).

---

# 4) Ключевые требования

## 4.1 Функциональные

1. Принять один или несколько **URL** YouTube (как `youtu.be`, так и `youtube.com/watch`).
2. Скачать «лучшую доступную» аудиодорожку и сконвертировать в заданный формат.
3. Сохранить файл в `./podcast/media/<video_id>.<ext>`.
4. Создать/обновить `./podcast/rss.xml`:

   * Канал: заголовок, описание, язык, автор, `atom:self`-ссылка.
   * Эпизод: `title`, `link`, `guid`, `pubDate`, `description`, `enclosure` (url, length, type), опционально `itunes:duration`, `itunes:image`.
   * Вставлять новый эпизод в начало (последние — сверху).
   * Обрезать ленту до `FEED_MAX_ITEMS`.
5. Не добавлять дубликаты, если `guid` уже существует.
6. Выводить понятные сообщения об ошибках.

## 4.2 Нефункциональные

* **Простота развёртывания:** одна команда установки зависимостей (Homebrew для macOS) + один скрипт Python.
* **Надёжность:** при падении на одном **URL** остальные продолжают обрабатываться.
* **Прозрачность:** чёткие логи в консоль.
* **Скорость:** эпизод появляется в **RSS** не позднее завершения конвертации (линейный конвейер).
* **Совместимость:** работает с популярными подкаст-клиентами (Apple Podcasts, Overcast и т.д.).

---

# 5) Допущения и ограничения

* YouTube может менять механизмы доставки: `yt-dlp` периодически требует обновления.
* Видео с ограниченным доступом/возрастом/региональными блокировками могут не качаться без куки.
* Лента и медиа считаются «личными»; если публикую на сторонний хостинг — отвечаю за правомерность.

---

# 6) Архитектура и компоненты

* **CLI-скрипт на Python 3.9+**: модульная структура (загрузка → конверт → запись **RSS**).
* **yt-dlp**: получение **JSON-метаданных** и загрузка аудио.
* **ffmpeg**: пост-обработка аудио.
* **Файловая система**: каталог `podcast/` с `media/` и `rss.xml`.
* **Хостинг (опционально)**: GitHub Pages / S3(R2) / локальный **NGINX**.

---

# 7) Потоки (flows)

1. **Add URLs**

   * Пользователь запускает: `python yt2pod.py <url1> <url2> ...`
2. **Download & Convert**

   * `yt-dlp` качает источник → `ffmpeg` приводит в целевой формат.
3. **Update RSS**

   * Читаем/создаём `rss.xml`, проверяем `guid`, вставляем новый `item`, сохраняем.
4. **Serve**

   * Если настроен статический хостинг: `rss.xml` доступен по `SITE_URL/rss.xml`, медиа — по `MEDIA_BASE_URL/<file>`.

---

# 8) Интерфейс и конфиг

## 8.1 CLI (Command-Line Interface)

```bash
python yt2pod.py <youtube_url> [youtube_url2 ...]
```

Опции (позже, не в v1): `--format mp3`, `--title "..."`, `--dry-run`.

## 8.2 Конфигурация

В начале скрипта:

* `SITE_URL` — базовый адрес фида (например, `https://username.github.io/my-podcast`).
* `MEDIA_BASE_URL` — адрес папки с аудио (например, `https://username.github.io/my-podcast/media`).
* `AUDIO_FORMAT` — `m4a` (по умолчанию) или `mp3`.
* `FEED_MAX_ITEMS` — лимит элементов фида.

---

# 9) Форматы данных

**Директории:**

```
podcast/
  media/
  rss.xml
```

**RSS 2.0 item (пример, усечённо):**

```xml
<item>
  <title>Lecture: XYZ</title>
  <link>https://www.youtube.com/watch?v=VIDEOID</link>
  <guid>VIDEOID</guid>
  <pubDate>Mon, 03 Nov 2025 10:21:00 +0000</pubDate>
  <description>Оригинальное описание YouTube…</description>
  <enclosure url="https://.../media/VIDEOID.m4a" length="12345678" type="audio/mp4"/>
  <itunes:duration>01:23:45</itunes:duration>
  <itunes:image href="https://i.ytimg.com/vi/VIDEOID/maxresdefault.jpg"/>
</item>
```

---

# 10) Обработка ошибок

* Нет сети/источник недоступен → печатаем «URL пропущен», продолжаем следующие.
* `ffmpeg` не установлен → явное сообщение с командой установки.
* Недостаточно места на диске → ошибка с подсказкой «освободить N мегабайт».
* Конфиг не задан (`SITE_URL`, `MEDIA_BASE_URL`) → остановка с инструкцией.

---

# 11) Безопасность и правовые аспекты

* Сервис предназначен для **личного использования**.
* Проверяю лицензионные условия оригинала; не публикую ленту публично, если это нарушает авторские права.
* При раздаче на внешнем хостинге выключаю индексацию (файл `robots.txt`, отсутствие каталогов-индексов), если хочу приватность «через незаметность». Для настоящей приватности — ограничение доступа по паролю/токену на стороне сервера (вне объёма v1).

---

# 12) Метрики успеха (OEC — Overall Evaluation Criterion, общий критерий оценки)

* **TTE (Time To Episode — время до эпизода):** от команды до появления эпизода в клиенте ≤ 3–5 мин для ролика ≤ 1 ч.
* **FR (Failure Rate — доля неудачных загрузок):** < 5% в течение недели активного использования.
* **DR (Duplicate Rate — доля дублей в RSS):** ≈ 0% (за счёт `guid = video_id`).
* **TTC (Time To Configure — время на настройку):** ≤ 10 минут на чистой машине macOS.

---

# 13) План релиза и критерии приёмки (DoD — Definition of Done, определение готовности)

**v1 (1 день работы):**

* [ ] Скрипт ставится на macOS с нуля: `brew install ffmpeg yt-dlp` + `python3 -m pip install yt-dlp`.
* [ ] Команда `python yt2pod.py <URL>` создаёт `media/` и `rss.xml`.
* [ ] Эпизод появляется в Apple Podcasts/Overcast по `SITE_URL/rss.xml`.
* [ ] Повторный запуск с тем же **URL** не создаёт дубль.
* [ ] Переключатель формата `AUDIO_FORMAT = "m4a" | "mp3"` работает.

---

# 14) Тест-план

* **Позитивные:** короткое видео (10–15 мин), длинное (60–120 мин), несколько **URL** разом.
* **Негативные:** битый **URL**, видео «только для взрослых», удалённое видео, исчерпание места.
* **Совместимость:** импорт **RSS** в Apple Podcasts и Overcast.
* **Идempotентность:** повторная обработка того же **URL** — без дубля.

---

# 15) Эксплуатация и развёртывание

* **Локально:** храню папку `podcast/` в любом месте (например, внутри git-репозитория).
* **Публикация (опционально):**

  * GitHub Pages: копирую `podcast/` в корень и пушу (`git push`).
  * S3/Cloudflare R2: зеркалю `podcast/` скриптом/CLI провайдера.
  * Домашний сервер: настраиваю **NGINX** на раздачу каталога.

---

# 16) Риски и как их снизить

* **Ломается загрузка из-за изменений на YouTube:** регулярно обновлять `yt-dlp`.
* **Качество аудио ниже ожиданий:** сохранять «best audio», без дополнительной перекодировки, либо повышать битрейт в `ffmpeg`.
* **RSS не читается клиентом:** валидировать через валидатор (онлайн), следить за `enclosure` и `length`.
* **Юридические риски:** использовать для личных офлайн-нужд; не публиковать публично без прав.

---

# 17) Дорожная карта (после v1 — nice-to-have)

* **Auto-push** в GitHub Pages (через **PAT — Personal Access Token, персональный токен доступа**).
* **ID3**-теги (формат метаданных для MP3) и встраивание обложки.
* Плейлисты YouTube (разворачивание в серию эпизодов).
* Авто-нормализация громкости, выравнивание уровня.
* Кэш метаданных (JSON) + «пересборка фида» из каталога.
* Мини-веб-панель (локально) для drag-and-drop **URL** (без бэкенда).

---

# 18) WBS (Work Breakdown Structure — иерархия работ)

1. **Setup**: проверить `python3`, `ffmpeg`, `yt-dlp`; подготовить каркас репозитория.
2. **Загрузка**: функция `download_audio(urls)` → `yt-dlp` → файл на диск.
3. **Конвертация**: пост-процессор `FFmpegExtractAudio` (`m4a`/`mp3`).
4. **RSS**: парс/создание `rss.xml`, `itunes`-поля, `atom:self`, `guid`, `pubDate`.
5. **Дедупликация**: проверка `guid` перед вставкой.
6. **Логи/ошибки**: единый обработчик, коды выхода.
7. **Документация**: `README.md` (установка/запуск), пример конфигурации.
8. **Smoke-тесты**: 3–5 реальных видео, импорт в клиент.